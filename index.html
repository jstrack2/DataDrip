<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const TrendingUp = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const TrendingDown = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
        <polyline points="17 18 23 18 23 12"></polyline>
      </svg>
    );

    const Plus = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Trash2 = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const RefreshCw = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
      </svg>
    );

    const Settings = ({className}) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"></path>
      </svg>
    );

    function PortfolioTracker() {
      const [holdings, setHoldings] = useState([]);
      const [prices, setPrices] = useState({});
      const [previousPrices, setPreviousPrices] = useState({});
      const [lastDataUpdate, setLastDataUpdate] = useState(null);
      const [loading, setLoading] = useState(false);
      const [progress, setProgress] = useState('');
      const [showAdd, setShowAdd] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showManualEntry, setShowManualEntry] = useState(false);
      const [callbackUrl, setCallbackUrl] = useState('');
      const [authenticated, setAuthenticated] = useState(false);
      const [editingHolding, setEditingHolding] = useState(null);
      const [editingTransaction, setEditingTransaction] = useState(null);
      const [addingToHolding, setAddingToHolding] = useState(null);
      const [editForm, setEditForm] = useState({ quantity: '', costBasis: '', date: '', type: 'buy', currentValue: '' });
      const [quickAddForm, setQuickAddForm] = useState({ quantity: '', costBasis: '', date: new Date().toISOString().split('T')[0], type: 'buy', currentValue: '' });
      const [credentials, setCredentials] = useState({
        appKey: '',
        appSecret: ''
      });
      const [tokens, setTokens] = useState({
        accessToken: '',
        refreshToken: '',
        expiresAt: 0
      });
      const [newHolding, setNewHolding] = useState({
        symbol: '',
        quantity: '',
        costBasis: '',
        type: 'stock',
        strike: '',
        expiration: '',
        date: new Date().toISOString().split('T')[0],
        transactionType: 'buy',
        currentValue: '',
        growthRate: '4.5'
      });

      useEffect(() => {
        const savedHoldings = localStorage.getItem('schwab_holdings');
        const savedCredentials = localStorage.getItem('schwab_credentials');
        const savedTokens = localStorage.getItem('schwab_tokens');
        const savedPreviousPrices = localStorage.getItem('schwab_previous_prices');
        
        if (savedHoldings) {
          const parsed = JSON.parse(savedHoldings);
          const migrated = parsed.map(h => {
            if (!h.transactions) {
              return {
                ...h,
                transactions: [{
                  id: Date.now() + Math.random(),
                  quantity: h.quantity || 0,
                  costBasis: h.costBasis || 0,
                  date: new Date().toISOString().split('T')[0],
                  type: 'buy'
                }]
              };
            }
            return {
              ...h,
              transactions: h.transactions.map(t => ({
                ...t,
                date: t.date || new Date().toISOString().split('T')[0],
                type: t.type || 'buy'
              })),
              growthRate: h.growthRate || 4.5,
              lastValueUpdate: h.lastValueUpdate || new Date().toISOString().split('T')[0]
            };
          });
          setHoldings(migrated);
        }
        
        if (savedCredentials) setCredentials(JSON.parse(savedCredentials));
        if (savedTokens) {
          const tokens = JSON.parse(savedTokens);
          setTokens(tokens);
          if (tokens.refreshToken && tokens.expiresAt > Date.now()) {
            setAuthenticated(true);
          }
        }
        
        if (savedPreviousPrices) {
          setPreviousPrices(JSON.parse(savedPreviousPrices));
        }
        
        const savedLastUpdate = localStorage.getItem('schwab_last_update');
        if (savedLastUpdate) {
          setLastDataUpdate(savedLastUpdate);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (code) {
          handleOAuthCallback(code);
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('schwab_holdings', JSON.stringify(holdings));
      }, [holdings]);

      useEffect(() => {
        localStorage.setItem('schwab_previous_prices', JSON.stringify(previousPrices));
      }, [previousPrices]);

      useEffect(() => {
        if (credentials.appKey && credentials.appSecret) {
          localStorage.setItem('schwab_credentials', JSON.stringify(credentials));
        }
      }, [credentials]);

      useEffect(() => {
        if (tokens.accessToken || tokens.refreshToken) {
          localStorage.setItem('schwab_tokens', JSON.stringify(tokens));
        }
      }, [tokens]);

      const handleOAuthCallback = async (code) => {
        setProgress('Exchanging code for tokens...');
        const savedCreds = JSON.parse(localStorage.getItem('schwab_credentials'));
        
        try {
          const authString = btoa(`${savedCreds.appKey}:${savedCreds.appSecret}`);
          
          const response = await fetch('http://localhost:5000/oauth/token', {
            method: 'POST',
            headers: {
              'Authorization': `Basic ${authString}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              grant_type: 'authorization_code',
              code: code,
              redirect_uri: 'https://127.0.0.1:8182'
            })
          });

          const data = await response.json();
          console.log('Token response:', data);

          if (data.access_token) {
            const newTokens = {
              accessToken: data.access_token,
              refreshToken: data.refresh_token,
              expiresAt: Date.now() + (data.expires_in * 1000)
            };
            setTokens(newTokens);
            setAuthenticated(true);
            setProgress('Authentication successful!');
            setTimeout(() => setProgress(''), 2000);
          } else {
            setProgress('Error: ' + (data.error_description || 'Failed to authenticate'));
          }
        } catch (error) {
          console.error('OAuth error:', error);
          setProgress('Error: ' + error.message);
        }
      };

      const login = () => {
        if (!credentials.appKey || !credentials.appSecret) {
          alert('Please enter your app key and secret');
          return;
        }

        const authUrl = `https://api.schwabapi.com/v1/oauth/authorize?client_id=${credentials.appKey}&redirect_uri=https://127.0.0.1:8182`;
        window.location.href = authUrl;
      };

      const refreshAccessToken = async () => {
        try {
          const authString = btoa(`${credentials.appKey}:${credentials.appSecret}`);
          
          const response = await fetch('http://localhost:5000/oauth/token', {
            method: 'POST',
            headers: {
              'Authorization': `Basic ${authString}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              grant_type: 'refresh_token',
              refresh_token: tokens.refreshToken
            })
          });

          const data = await response.json();
          
          if (data.access_token) {
            const newTokens = {
              ...tokens,
              accessToken: data.access_token,
              expiresAt: Date.now() + (data.expires_in * 1000)
            };
            setTokens(newTokens);
            return newTokens.accessToken;
          }
        } catch (error) {
          console.error('Token refresh error:', error);
          setAuthenticated(false);
          return null;
        }
      };

      const getValidAccessToken = async () => {
        if (tokens.expiresAt > Date.now() + 60000) {
          return tokens.accessToken;
        }
        return await refreshAccessToken();
      };

      const fetchPrices = async () => {
        if (!authenticated) {
          alert('Please authenticate with Schwab first');
          return;
        }

        setLoading(true);
        setProgress('Fetching prices...');

        try {
          const accessToken = await getValidAccessToken();
          if (!accessToken) {
            alert('Authentication expired. Please log in again.');
            setAuthenticated(false);
            setLoading(false);
            return;
          }

          const newPrices = {};

          // Fetch stock prices
          const stocks = holdings.filter(h => h.type === 'stock');
          if (stocks.length > 0) {
            const symbols = stocks.map(s => s.symbol).join(',');
            const response = await fetch(
              `http://localhost:5000/marketdata/v1/quotes?symbols=${symbols}&fields=quote`,
              {
                headers: {
                  'Authorization': `Bearer ${accessToken}`
                }
              }
            );

            const data = await response.json();
            console.log('Stock quotes:', data);

            for (const [symbol, quoteData] of Object.entries(data)) {
              if (quoteData.quote && quoteData.quote.lastPrice) {
                newPrices[symbol] = quoteData.quote.lastPrice;
              }
            }
          }

          // Fetch option prices in parallel with filtering
          const options = holdings.filter(h => h.type === 'call' || h.type === 'put');
          
          if (options.length > 0) {
            setProgress(`Fetching ${options.length} option prices...`);
            
            // Create array of fetch promises
            const optionFetches = options.map(option => {
              const contractType = option.type === 'call' ? 'CALL' : 'PUT';
              const url = `http://localhost:5000/marketdata/v1/chains?symbol=${option.symbol}&contractType=${contractType}&fromDate=${option.expiration}&toDate=${option.expiration}&includeQuotes=true`;
              
              return fetch(url, {
                headers: {
                  'Authorization': `Bearer ${accessToken}`
                }
              })
              .then(response => response.json())
              .then(data => ({ option, data }))
              .catch(error => {
                console.error(`Error fetching ${option.symbol} ${option.type}:`, error);
                return { option, data: null };
              });
            });

            // Fetch all options in parallel
            const results = await Promise.all(optionFetches);
            
            // Process results
            results.forEach(({ option, data }) => {
              if (!data) return;
              
              console.log(`Option chain for ${option.symbol} ${option.type} ${option.strike}:`, data);

              let foundPrice = null;
              const targetMap = option.type === 'call' ? data.callExpDateMap : data.putExpDateMap;
              
              if (targetMap) {
                for (const [expKey, strikes] of Object.entries(targetMap)) {
                  const expDatePart = expKey.split(':')[0];
                  
                  if (expDatePart === option.expiration) {
                    const strikeStr = parseFloat(option.strike).toFixed(1);
                    
                    if (strikes[strikeStr] && strikes[strikeStr].length > 0) {
                      const contract = strikes[strikeStr][0];
                      foundPrice = contract.last || contract.mark || contract.bid || 0;
                      break;
                    }
                  }
                }
              }

              if (foundPrice !== null) {
                newPrices[`${option.symbol}-${option.strike}-${option.expiration}-${option.type}`] = foundPrice;
              }
            });
          }

          setPrices(newPrices);
          setPreviousPrices(prices); // Save current prices as previous before updating
          const updateTime = new Date().toISOString();
          setLastDataUpdate(updateTime);
          localStorage.setItem('schwab_last_update', updateTime);
          setProgress('Update complete!');
          setTimeout(() => setProgress(''), 2000);
        } catch (error) {
          console.error('Error fetching prices:', error);
          setProgress('Error: ' + error.message);
        }

        setLoading(false);
      };

      const addHolding = () => {
        if (newHolding.symbol && ((newHolding.type === 'fund' && newHolding.costBasis && newHolding.currentValue) || (newHolding.type !== 'fund' && newHolding.quantity && newHolding.costBasis))) {
          if ((newHolding.type === 'call' || newHolding.type === 'put') && (!newHolding.strike || !newHolding.expiration)) {
            alert('Please enter strike price and expiration date for options');
            return;
          }

          const existingHolding = holdings.find(h => 
            h.symbol === newHolding.symbol &&
            h.type === newHolding.type &&
            (h.type === 'stock' || h.type === 'fund' || (h.strike === parseFloat(newHolding.strike) && h.expiration === newHolding.expiration))
          );

          if (existingHolding) {
            const updatedHoldings = holdings.map(h => {
              if (h.id === existingHolding.id) {
                return {
                  ...h,
                  currentValue: newHolding.type === 'fund' && newHolding.currentValue ? parseFloat(newHolding.currentValue) : h.currentValue,
                  lastValueUpdate: newHolding.type === 'fund' && newHolding.currentValue ? newHolding.date : h.lastValueUpdate,
                  transactions: [...h.transactions, {
                    id: Date.now(),
                    quantity: newHolding.type === 'fund' ? 1 : parseFloat(newHolding.quantity),
                    costBasis: parseFloat(newHolding.costBasis),
                    date: newHolding.date,
                    type: newHolding.transactionType
                  }]
                };
              }
              return h;
            });
            setHoldings(updatedHoldings);
          } else {
            setHoldings([...holdings, {
              symbol: newHolding.symbol,
              type: newHolding.type,
              strike: newHolding.strike ? parseFloat(newHolding.strike) : null,
              expiration: newHolding.expiration || null,
              currentValue: newHolding.type === 'fund' ? (parseFloat(newHolding.currentValue) || null) : undefined,
              growthRate: newHolding.type === 'fund' ? (parseFloat(newHolding.growthRate) || 4.5) : undefined,
              lastValueUpdate: newHolding.type === 'fund' ? newHolding.date : undefined,
              id: Date.now(),
              transactions: [{
                id: Date.now(),
                quantity: newHolding.type === 'fund' ? 1 : parseFloat(newHolding.quantity),
                costBasis: parseFloat(newHolding.costBasis),
                date: newHolding.date,
                type: newHolding.transactionType
              }]
            }]);
          }
          
          setNewHolding({ symbol: '', quantity: '', costBasis: '', type: 'stock', strike: '', expiration: '', date: new Date().toISOString().split('T')[0], transactionType: 'buy', currentValue: '', growthRate: '4.5' });
          setShowAdd(false);
        }
      };

      const addQuickTransaction = (holdingId) => {
        const holding = holdings.find(h => h.id === holdingId);
        
        if (holding.type === 'fund') {
          if (!quickAddForm.costBasis) {
            alert('Please enter cost basis');
            return;
          }
        } else {
          if (!quickAddForm.quantity || !quickAddForm.costBasis) {
            alert('Please enter quantity and cost basis');
            return;
          }
        }

        const updatedHoldings = holdings.map(h => {
          if (h.id === holdingId) {
            return {
              ...h,
              transactions: [...h.transactions, {
                id: Date.now(),
                quantity: h.type === 'fund' ? 1 : parseFloat(quickAddForm.quantity),
                costBasis: parseFloat(quickAddForm.costBasis),
                date: quickAddForm.date,
                type: quickAddForm.type
              }]
            };
          }
          return h;
        });
        
        setHoldings(updatedHoldings);
        setAddingToHolding(null);
        setQuickAddForm({ quantity: '', costBasis: '', date: new Date().toISOString().split('T')[0], type: 'buy', currentValue: '' });
      };

      const removeHolding = (id) => {
        setHoldings(holdings.filter(h => h.id !== id));
      };

      const exportPortfolioData = async () => {
        const password = prompt('Enter a password to encrypt your portfolio data:');
        if (!password) return;
        
        const exportData = {
          holdings,
          prices,
          previousPrices,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        try {
          const dataStr = JSON.stringify(exportData);
          const encrypted = await encryptData(dataStr, password);
          
          const dataBlob = new Blob([encrypted], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `portfolio-data-${new Date().toISOString().split('T')[0]}.enc`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Export error:', error);
          alert('Error exporting data');
        }
      };

      const encryptData = async (data, password) => {
        const encoder = new TextEncoder();
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          encoder.encode(password),
          'PBKDF2',
          false,
          ['deriveBits', 'deriveKey']
        );
        
        const key = await crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: salt,
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt']
        );
        
        const encryptedData = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv: iv },
          key,
          encoder.encode(data)
        );
        
        const combined = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
        combined.set(salt, 0);
        combined.set(iv, salt.length);
        combined.set(new Uint8Array(encryptedData), salt.length + iv.length);
        
        return btoa(String.fromCharCode(...combined));
      };

      const decryptData = async (encryptedData, password) => {
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();
        
        const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
        const salt = combined.slice(0, 16);
        const iv = combined.slice(16, 28);
        const data = combined.slice(28);
        
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          encoder.encode(password),
          'PBKDF2',
          false,
          ['deriveBits', 'deriveKey']
        );
        
        const key = await crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: salt,
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['decrypt']
        );
        
        const decryptedData = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: iv },
          key,
          data
        );
        
        return decoder.decode(decryptedData);
      };

      const importPortfolioData = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const password = prompt('Enter the password to decrypt your portfolio data:');
        if (!password) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const encryptedData = e.target.result;
            const decryptedStr = await decryptData(encryptedData, password);
            const importData = JSON.parse(decryptedStr);
            
            if (!importData.holdings || !importData.prices) {
              alert('Invalid portfolio data file');
              return;
            }
            
            setHoldings(importData.holdings);
            setPrices(importData.prices);
            setPreviousPrices(importData.previousPrices || {});
            setLastDataUpdate(importData.exportDate);
            localStorage.setItem('schwab_last_update', importData.exportDate);
            
            setProgress('Portfolio data imported successfully!');
            setTimeout(() => setProgress(''), 3000);
          } catch (error) {
            console.error('Import error:', error);
            alert('Error importing portfolio data. Wrong password or corrupted file.');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const handleManualCallback = () => {
        try {
          const url = new URL(callbackUrl);
          const code = url.searchParams.get('code');
          if (code) {
            handleOAuthCallback(code);
          } else {
            setProgress('Error: No code found in URL');
          }
        } catch (e) {
          setProgress('Error: Invalid URL format');
        }
      };

      const calculateFundValue = (fund) => {
        if (!fund.currentValue && !fund.lastValueUpdate) {
          // No value set yet, just use cost basis sum
          let totalCost = 0;
          fund.transactions.forEach(t => {
            totalCost += (t.type === 'sell' ? -1 : 1) * t.costBasis;
          });
          return totalCost;
        }
        
        const lastUpdate = new Date(fund.lastValueUpdate || fund.transactions[fund.transactions.length - 1].date);
        const now = new Date();
        const daysSinceUpdate = (now - lastUpdate) / (1000 * 60 * 60 * 24);
        const yearsSinceUpdate = daysSinceUpdate / 365;
        
        const growthRate = (fund.growthRate || 0) / 100;
        const baseValue = fund.currentValue || fund.transactions.reduce((sum, t) => sum + (t.type === 'sell' ? -1 : 1) * t.costBasis, 0);
        
        return baseValue * Math.pow(1 + growthRate, yearsSinceUpdate);
      };

      const calculateMetrics = () => {
        let totalValue = 0;
        let totalCost = 0;
        
        holdings.forEach(h => {
          if (h.type === 'fund') {
            // For funds, use the growth-calculated current value
            let fundCost = 0;
            h.transactions.forEach(t => {
              fundCost += (t.type === 'sell' ? -1 : 1) * t.costBasis;
            });
            const fundValue = calculateFundValue(h);
            totalCost += fundCost;
            totalValue += fundValue;
          } else {
            const priceKey = h.type === 'stock' 
              ? h.symbol 
              : `${h.symbol}-${h.strike}-${h.expiration}-${h.type}`;
            
            const price = prices[priceKey] || 0;
            const multiplier = (h.type === 'call' || h.type === 'put') ? 100 : 1;
            
            let totalQuantity = 0;
            let transactionsCost = 0;
            
            h.transactions.forEach(t => {
              const qty = t.type === 'sell' ? -t.quantity : t.quantity;
              totalQuantity += qty;
              transactionsCost += (t.type === 'sell' ? -1 : 1) * (t.quantity * t.costBasis * multiplier);
            });
            
            totalValue += price * totalQuantity * multiplier;
            totalCost += transactionsCost;
          }
        });

        const gain = totalValue - totalCost;
        const gainPercent = totalCost > 0 ? (gain / totalCost) * 100 : 0;

        return { totalValue, totalCost, gain, gainPercent };
      };

      const calculateDailyChanges = () => {
        let stocksChange = 0;
        let optionsChange = 0;
        let fundsChange = 0;
        let stocksPrevValue = 0;
        let optionsPrevValue = 0;
        let fundsPrevValue = 0;
        
        holdings.forEach(h => {
          if (h.type === 'fund') {
            // Funds don't have daily price changes, skip for now
            return;
          }
          
          const priceKey = h.type === 'stock' ? h.symbol : `${h.symbol}-${h.strike}-${h.expiration}-${h.type}`;
          const currentPrice = prices[priceKey] || 0;
          const previousPrice = previousPrices[priceKey] || currentPrice;
          const multiplier = (h.type === 'call' || h.type === 'put') ? 100 : 1;
          
          let totalQuantity = 0;
          h.transactions.forEach(t => {
            totalQuantity += (t.type === 'sell' ? -t.quantity : t.quantity);
          });
          
          const currentValue = currentPrice * totalQuantity * multiplier;
          const previousValue = previousPrice * totalQuantity * multiplier;
          const change = currentValue - previousValue;
          
          if (h.type === 'stock') {
            stocksChange += change;
            stocksPrevValue += previousValue;
          } else {
            optionsChange += change;
            optionsPrevValue += previousValue;
          }
        });
        
        const totalChange = stocksChange + optionsChange + fundsChange;
        const totalPrevValue = stocksPrevValue + optionsPrevValue + fundsPrevValue;
        
        return {
          stocks: { change: stocksChange, percent: stocksPrevValue > 0 ? (stocksChange / stocksPrevValue) * 100 : 0 },
          options: { change: optionsChange, percent: optionsPrevValue > 0 ? (optionsChange / optionsPrevValue) * 100 : 0 },
          funds: { change: fundsChange, percent: fundsPrevValue > 0 ? (fundsChange / fundsPrevValue) * 100 : 0 },
          total: { change: totalChange, percent: totalPrevValue > 0 ? (totalChange / totalPrevValue) * 100 : 0 }
        };
      };

      const metrics = calculateMetrics();
      const dailyChanges = calculateDailyChanges();

      // Sort holdings: funds first, then stocks, then options, alphabetically within each group
      const sortedHoldings = [...holdings].sort((a, b) => {
        const typeOrder = { fund: 0, stock: 1, call: 2, put: 2 };
        const typeCompare = typeOrder[a.type] - typeOrder[b.type];
        
        if (typeCompare !== 0) return typeCompare;
        
        // Within same type, sort alphabetically by symbol
        return a.symbol.localeCompare(b.symbol);
      });

      if (!authenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4 flex items-center justify-center">
            <div className="bg-slate-800 rounded-lg p-8 max-w-md w-full shadow-xl">
              <h1 className="text-3xl font-bold text-white mb-4">Portfolio Tracker</h1>
              <p className="text-slate-300 mb-6">
                Connect to Schwab to get real-time stock and options prices
              </p>
              
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm text-slate-300 mb-1">Schwab App Key</label>
                  <input
                    type="text"
                    value={credentials.appKey}
                    onChange={(e) => setCredentials({...credentials, appKey: e.target.value})}
                    placeholder="From developer.schwab.com"
                    className="w-full bg-slate-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm text-slate-300 mb-1">Schwab App Secret</label>
                  <input
                    type="password"
                    value={credentials.appSecret}
                    onChange={(e) => setCredentials({...credentials, appSecret: e.target.value})}
                    placeholder="From developer.schwab.com"
                    className="w-full bg-slate-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              {progress && (
                <div className="mb-4 p-3 bg-slate-700 rounded-lg text-sm text-slate-300">
                  {progress}
                </div>
              )}

              {!showManualEntry ? (
                <>
                  <button
                    onClick={login}
                    disabled={!credentials.appKey || !credentials.appSecret}
                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white py-3 rounded-lg font-semibold transition-colors mb-3"
                  >
                    Login to Schwab
                  </button>
                  <button
                    onClick={() => setShowManualEntry(true)}
                    className="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition-colors"
                  >
                    Already logged in? Paste callback URL
                  </button>
                </>
              ) : (
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm text-slate-300 mb-1">
                      Paste the callback URL from your browser
                    </label>
                    <input
                      type="text"
                      value={callbackUrl}
                      onChange={(e) => setCallbackUrl(e.target.value)}
                      placeholder="https://127.0.0.1:8182/?code=..."
                      className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    />
                    <p className="text-xs text-slate-400 mt-1">
                      Copy the URL from the error page's address bar
                    </p>
                  </div>
                  <button
                    onClick={handleManualCallback}
                    disabled={!callbackUrl}
                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white py-2 rounded-lg font-semibold transition-colors"
                  >
                    Complete Authentication
                  </button>
                  <button
                    onClick={() => setShowManualEntry(false)}
                    className="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm transition-colors"
                  >
                    Back
                  </button>
                </div>
              )}

              <p className="text-xs text-slate-400 mt-4">
                Your credentials are stored locally and only used to authenticate with Schwab
              </p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="bg-slate-800 rounded-lg p-6 mb-4 shadow-xl">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-2xl font-bold text-white">Portfolio</h1>
                <div className="flex gap-2">
                  <button
                    onClick={exportPortfolioData}
                    className="p-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors"
                    title="Export portfolio data"
                  >
                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                  </button>
                  <label className="p-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors cursor-pointer" title="Import portfolio data">
                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <input
                      type="file"
                      accept=".json"
                      onChange={importPortfolioData}
                      className="hidden"
                    />
                  </label>
                  <button
                    onClick={fetchPrices}
                    disabled={loading || holdings.length === 0}
                    className="p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 rounded-lg transition-colors"
                    title="Refresh prices"
                  >
                    <RefreshCw className={`w-5 h-5 text-white ${loading ? 'animate-spin' : ''}`} />
                  </button>
                  <button
                    onClick={() => setShowSettings(!showSettings)}
                    className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors"
                    title="Settings"
                  >
                    <Settings className="w-5 h-5 text-white" />
                  </button>
                </div>
              </div>

              {progress && (
                <div className="mb-4 p-3 bg-slate-700 rounded-lg text-sm text-slate-300">
                  {progress}
                </div>
              )}

              {lastDataUpdate && (
                <div className="mb-4 p-2 bg-slate-700 rounded-lg text-xs text-slate-400">
                  Data updated: {new Date(lastDataUpdate).toLocaleString()}
                  {(() => {
                    const hoursSinceUpdate = (Date.now() - new Date(lastDataUpdate)) / (1000 * 60 * 60);
                    if (hoursSinceUpdate > 48) {
                      return <span className="ml-2 text-yellow-400">⚠ Data is {Math.floor(hoursSinceUpdate / 24)} days old</span>;
                    }
                    return null;
                  })()}
                </div>
              )}

              {showSettings && (
                <div className="mb-4 p-4 bg-slate-700 rounded-lg">
                  <p className="text-sm text-slate-300 mb-2">Authenticated with Schwab</p>
                  <button
                    onClick={() => {
                      setAuthenticated(false);
                      setTokens({ accessToken: '', refreshToken: '', expiresAt: 0 });
                      localStorage.removeItem('schwab_tokens');
                    }}
                    className="text-sm text-red-400 hover:text-red-300"
                  >
                    Logout
                  </button>
                  <p className="text-xs text-slate-400 mt-2">
                    Re-authenticate every 7 days
                  </p>
                </div>
              )}

              <div className="text-4xl font-bold text-white mb-2">
                ${metrics.totalValue.toFixed(2)}
              </div>
              
              <div className={`flex items-center text-lg mb-1 ${metrics.gain >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                {metrics.gain >= 0 ? <TrendingUp className="w-5 h-5 mr-1" /> : <TrendingDown className="w-5 h-5 mr-1" />}
                <span className="font-semibold">
                  ${Math.abs(metrics.gain).toFixed(2)} ({metrics.gainPercent >= 0 ? '+' : ''}{metrics.gainPercent.toFixed(2)}%)
                </span>
              </div>
              <div className="text-sm text-slate-400 mb-3">
                Cost Basis: ${metrics.totalCost.toFixed(2)}
              </div>

              {Object.keys(previousPrices).length > 0 && (
                <div className="pt-3 border-t border-slate-700">
                  <div className="text-xs text-slate-400 mb-2">Today's Change</div>
                  <div className={`flex items-center text-base ${dailyChanges.total.change >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {dailyChanges.total.change >= 0 ? <TrendingUp className="w-4 h-4 mr-1" /> : <TrendingDown className="w-4 h-4 mr-1" />}
                    <span className="font-semibold">
                      {dailyChanges.total.change >= 0 ? '+' : ''}${dailyChanges.total.change.toFixed(2)} ({dailyChanges.total.percent >= 0 ? '+' : ''}{dailyChanges.total.percent.toFixed(2)}%)
                    </span>
                  </div>
                  <div className="grid grid-cols-3 gap-2 mt-2 text-xs">
                    <div className="bg-slate-700 rounded p-2">
                      <div className="text-slate-400">Stocks</div>
                      <div className={dailyChanges.stocks.change >= 0 ? 'text-green-400' : 'text-red-400'}>
                        {dailyChanges.stocks.change >= 0 ? '+' : ''}${dailyChanges.stocks.change.toFixed(2)}
                      </div>
                    </div>
                    <div className="bg-slate-700 rounded p-2">
                      <div className="text-slate-400">Options</div>
                      <div className={dailyChanges.options.change >= 0 ? 'text-green-400' : 'text-red-400'}>
                        {dailyChanges.options.change >= 0 ? '+' : ''}${dailyChanges.options.change.toFixed(2)}
                      </div>
                    </div>
                    <div className="bg-slate-700 rounded p-2">
                      <div className="text-slate-400">Funds</div>
                      <div className={dailyChanges.funds.change >= 0 ? 'text-green-400' : 'text-red-400'}>
                        {dailyChanges.funds.change >= 0 ? '+' : ''}${dailyChanges.funds.change.toFixed(2)}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="space-y-3 mb-4">
              {sortedHoldings.map(holding => {
                if (holding.type === 'fund') {
                  // Handle funds separately - they have a single current value for the entire position
                  let totalCost = 0;
                  
                  holding.transactions.forEach(t => {
                    totalCost += (t.type === 'sell' ? -1 : 1) * t.costBasis;
                  });
                  
                  const totalValue = calculateFundValue(holding);
                  const gain = totalValue - totalCost;
                  const gainPercent = totalCost > 0 ? (gain / totalCost) * 100 : 0;

                  const isExpanded = editingHolding === holding.id;

                  return (
                    <div key={holding.id} className="bg-slate-800 rounded-lg p-4 shadow-lg">
                      <div 
                        className="cursor-pointer hover:bg-slate-750 rounded transition-colors"
                        onClick={() => setEditingHolding(isExpanded ? null : holding.id)}
                        title="Click to view/edit transactions"
                      >
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <div className="flex items-center gap-2">
                              <h3 className="text-xl font-bold text-white">{holding.symbol}</h3>
                              <span className="text-xs px-2 py-1 bg-purple-600 rounded text-white">
                                fund
                              </span>
                              <span className="text-xs px-2 py-1 bg-slate-700 rounded text-slate-300">
                                {holding.growthRate || 4.5}% APY
                              </span>
                              {holding.transactions.length > 1 && (
                                <span className="text-xs px-2 py-1 bg-blue-600 rounded text-white">
                                  {holding.transactions.length} lots
                                </span>
                              )}
                            </div>
                            <div className="text-sm text-slate-400">
                              Auto-calculated value
                            </div>
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              removeHolding(holding.id);
                            }}
                            className="text-slate-400 hover:text-red-400 transition-colors"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                        
                        <div className="flex justify-between items-end">
                          <div>
                            <div className="text-2xl font-bold text-white">
                              ${totalValue.toFixed(2)}
                            </div>
                            <div className="text-xs text-slate-500">
                              Cost: ${totalCost.toFixed(2)}
                            </div>
                          </div>
                          <div className={`text-right ${gain >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                            <div className="font-semibold">
                              {gain >= 0 ? '+' : ''}${gain.toFixed(2)}
                            </div>
                            <div className="text-sm">
                              {gainPercent >= 0 ? '+' : ''}{gainPercent.toFixed(2)}%
                            </div>
                          </div>
                        </div>
                      </div>

                      {isExpanded && (
                        <div className="mt-4 pt-4 border-t border-slate-700">
                          <div className="mb-4 bg-slate-700 rounded p-3 space-y-2">
                            <div>
                              <label className="block text-xs text-slate-400 mb-1">Current Fund Value (Manual Update)</label>
                              <input
                                type="number"
                                value={holding.currentValue || totalValue}
                                onChange={(e) => {
                                  const updatedHoldings = holdings.map(h => {
                                    if (h.id === holding.id) {
                                      return { 
                                        ...h, 
                                        currentValue: parseFloat(e.target.value) || 0,
                                        lastValueUpdate: new Date().toISOString().split('T')[0]
                                      };
                                    }
                                    return h;
                                  });
                                  setHoldings(updatedHoldings);
                                }}
                                placeholder="12000.00"
                                step="0.01"
                                className="w-full bg-slate-600 text-white px-3 py-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                              />
                              <p className="text-xs text-slate-500 mt-1">Set the actual value to reset growth calculation</p>
                            </div>
                            <div>
                              <label className="block text-xs text-slate-400 mb-1">Annual Growth Rate (%)</label>
                              <input
                                type="number"
                                value={holding.growthRate || 4.5}
                                onChange={(e) => {
                                  const updatedHoldings = holdings.map(h => {
                                    if (h.id === holding.id) {
                                      return { ...h, growthRate: parseFloat(e.target.value) || 0 };
                                    }
                                    return h;
                                  });
                                  setHoldings(updatedHoldings);
                                }}
                                placeholder="4.5"
                                step="0.1"
                                className="w-full bg-slate-600 text-white px-3 py-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                              />
                              <p className="text-xs text-slate-500 mt-1">Typical money market rate</p>
                            </div>
                          </div>

                          <h4 className="text-sm font-semibold text-slate-300 mb-3">Purchase History</h4>
                          <div className="space-y-2 mb-3">
                            {holding.transactions.map((transaction) => {
                              const isEditing = editingTransaction === transaction.id;
                              const isSell = transaction.type === 'sell';
                              
                              return (
                                <div key={transaction.id} className="bg-slate-700 rounded p-3">
                                  {!isEditing ? (
                                    <div className="flex justify-between items-center">
                                      <div>
                                        <div className="flex items-center gap-2">
                                          <span className={`text-xs px-2 py-0.5 rounded ${isSell ? 'bg-red-600' : 'bg-green-600'} text-white`}>
                                            {isSell ? 'SELL' : 'BUY'}
                                          </span>
                                          <span className="text-white">
                                            ${transaction.costBasis.toFixed(2)}
                                          </span>
                                        </div>
                                        <div className="text-xs text-slate-400 mt-1">
                                          {new Date(transaction.date).toLocaleDateString()}
                                        </div>
                                      </div>
                                      <div className="flex gap-2">
                                        <button
                                          onClick={() => {
                                            setEditingTransaction(transaction.id);
                                            setEditForm({
                                              quantity: '1',
                                              costBasis: transaction.costBasis.toString(),
                                              currentValue: '',
                                              date: transaction.date,
                                              type: transaction.type
                                            });
                                          }}
                                          className="text-blue-400 hover:text-blue-300 text-sm"
                                        >
                                          Edit
                                        </button>
                                        <button
                                          onClick={() => {
                                            const updatedHoldings = holdings.map(h => {
                                              if (h.id === holding.id) {
                                                const newTransactions = h.transactions.filter(t => t.id !== transaction.id);
                                                if (newTransactions.length === 0) {
                                                  return null;
                                                }
                                                return { ...h, transactions: newTransactions };
                                              }
                                              return h;
                                            }).filter(Boolean);
                                            setHoldings(updatedHoldings);
                                          }}
                                          className="text-red-400 hover:text-red-300 text-sm"
                                        >
                                          Remove
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="space-y-2">
                                      <div className="grid grid-cols-2 gap-2">
                                        <div>
                                          <label className="block text-xs text-slate-400 mb-1">Type</label>
                                          <select
                                            value={editForm.type}
                                            onChange={(e) => setEditForm({...editForm, type: e.target.value})}
                                            className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          >
                                            <option value="buy">Buy</option>
                                            <option value="sell">Sell</option>
                                          </select>
                                        </div>
                                        <div>
                                          <label className="block text-xs text-slate-400 mb-1">Date</label>
                                          <input
                                            type="date"
                                            value={editForm.date}
                                            onChange={(e) => setEditForm({...editForm, date: e.target.value})}
                                            className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          />
                                        </div>
                                      </div>
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Amount</label>
                                        <input
                                          type="number"
                                          value={editForm.costBasis}
                                          onChange={(e) => setEditForm({...editForm, costBasis: e.target.value})}
                                          step="0.01"
                                          className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                      </div>
                                      <div className="flex gap-2">
                                        <button
                                          onClick={() => {
                                            const updatedHoldings = holdings.map(h => {
                                              if (h.id === holding.id) {
                                                return {
                                                  ...h,
                                                  transactions: h.transactions.map(t => {
                                                    if (t.id === transaction.id) {
                                                      return {
                                                        ...t,
                                                        quantity: 1,
                                                        costBasis: parseFloat(editForm.costBasis),
                                                        date: editForm.date,
                                                        type: editForm.type
                                                      };
                                                    }
                                                    return t;
                                                  })
                                                };
                                              }
                                              return h;
                                            });
                                            setHoldings(updatedHoldings);
                                            setEditingTransaction(null);
                                          }}
                                          className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-sm"
                                        >
                                          Save
                                        </button>
                                        <button
                                          onClick={() => setEditingTransaction(null)}
                                          className="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-1 rounded text-sm"
                                        >
                                          Cancel
                                        </button>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>

                          {addingToHolding === holding.id ? (
                            <div className="bg-slate-700 rounded p-3 space-y-2">
                              <div className="grid grid-cols-2 gap-2">
                                <div>
                                  <label className="block text-xs text-slate-400 mb-1">Type</label>
                                  <select
                                    value={quickAddForm.type}
                                    onChange={(e) => setQuickAddForm({...quickAddForm, type: e.target.value})}
                                    className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="buy">Buy</option>
                                    <option value="sell">Sell</option>
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-xs text-slate-400 mb-1">Date</label>
                                  <input
                                    type="date"
                                    value={quickAddForm.date}
                                    onChange={(e) => setQuickAddForm({...quickAddForm, date: e.target.value})}
                                    className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-400 mb-1">Amount</label>
                                <input
                                  type="number"
                                  value={quickAddForm.costBasis}
                                  onChange={(e) => setQuickAddForm({...quickAddForm, costBasis: e.target.value})}
                                  placeholder="1000.00"
                                  step="0.01"
                                  className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => addQuickTransaction(holding.id)}
                                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-sm"
                                >
                                  Add Purchase
                                </button>
                                <button
                                  onClick={() => {
                                    setAddingToHolding(null);
                                    setQuickAddForm({ quantity: '', costBasis: '', date: new Date().toISOString().split('T')[0], type: 'buy', currentValue: '' });
                                  }}
                                  className="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-1 rounded text-sm"
                                >
                                  Cancel
                                </button>
                              </div>
                            </div>
                          ) : (
                            <button
                              onClick={() => setAddingToHolding(holding.id)}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm flex items-center justify-center gap-1"
                            >
                              <Plus className="w-4 h-4" />
                              Add Purchase
                            </button>
                          )}
                        </div>
                      )}
                    </div>
                  );
                }
                
                // Handle stocks and options
                const priceKey = holding.type === 'stock' 
                  ? holding.symbol 
                  : `${holding.symbol}-${holding.strike}-${holding.expiration}-${holding.type}`;
                
                const currentPrice = prices[priceKey] || 0;
                const multiplier = (holding.type === 'call' || holding.type === 'put') ? 100 : 1;
                
                let totalQuantity = 0;
                let totalCost = 0;
                
                holding.transactions.forEach(t => {
                  const qty = (t.type === 'sell' ? -t.quantity : t.quantity);
                  totalQuantity += qty;
                  totalCost += (t.type === 'sell' ? -1 : 1) * (t.quantity * t.costBasis * multiplier);
                });
                
                const avgCostBasis = totalQuantity !== 0 ? Math.abs(totalCost / totalQuantity / multiplier) : 0;
                
                const currentValue = currentPrice * totalQuantity * multiplier;
                const gain = currentValue - totalCost;
                const gainPercent = totalCost > 0 ? (gain / totalCost) * 100 : 0;

                // Calculate daily change
                const previousPrice = previousPrices[priceKey] || currentPrice;
                const previousValue = previousPrice * totalQuantity * multiplier;
                const dailyChange = currentValue - previousValue;
                const dailyChangePercent = previousValue > 0 ? (dailyChange / previousValue) * 100 : 0;
                const priceChange = currentPrice - previousPrice;
                const priceChangePercent = previousPrice > 0 ? (priceChange / previousPrice) * 100 : 0;

                const isExpanded = editingHolding === holding.id;

                return (
                  <div key={holding.id} className="bg-slate-800 rounded-lg p-4 shadow-lg">
                    <div 
                      className="cursor-pointer hover:bg-slate-750 rounded transition-colors"
                      onClick={() => setEditingHolding(isExpanded ? null : holding.id)}
                      title="Click to view/edit transactions"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="flex items-center gap-2">
                            <h3 className="text-xl font-bold text-white">{holding.symbol}</h3>
                            <span className="text-xs px-2 py-1 bg-slate-700 rounded text-slate-300">
                              {holding.type}
                            </span>
                            {holding.transactions.length > 1 && (
                              <span className="text-xs px-2 py-1 bg-blue-600 rounded text-white">
                                {holding.transactions.length} lots
                              </span>
                            )}
                          </div>
                          <div className="text-sm text-slate-400">
                            {totalQuantity} × ${currentPrice.toFixed(2)}
                            {multiplier === 100 && <span className="text-slate-500"> × 100</span>}
                            {Object.keys(previousPrices).length > 0 && (
                              <span className={`ml-2 ${priceChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                ({priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}, {priceChangePercent >= 0 ? '+' : ''}{priceChangePercent.toFixed(2)}%)
                              </span>
                            )}
                          </div>
                          {(holding.type === 'call' || holding.type === 'put') && (
                            <div className="text-xs text-slate-500 mt-1">
                              ${holding.strike} strike · {new Date(holding.expiration).toLocaleDateString()}
                            </div>
                          )}
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            removeHolding(holding.id);
                          }}
                          className="text-slate-400 hover:text-red-400 transition-colors"
                        >
                          <Trash2 className="w-5 h-5" />
                        </button>
                      </div>
                      
                      <div className="flex justify-between items-end">
                        <div>
                          <div className="text-2xl font-bold text-white">
                            ${currentValue.toFixed(2)}
                          </div>
                          <div className="text-xs text-slate-500">
                            Cost: ${totalCost.toFixed(2)} (avg ${avgCostBasis.toFixed(2)})
                          </div>
                          {Object.keys(previousPrices).length > 0 && (
                            <div className={`text-xs mt-1 ${dailyChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              Today: {dailyChange >= 0 ? '+' : ''}${dailyChange.toFixed(2)} ({dailyChangePercent >= 0 ? '+' : ''}{dailyChangePercent.toFixed(2)}%)
                            </div>
                          )}
                        </div>
                        <div className={`text-right ${gain >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          <div className="font-semibold">
                            {gain >= 0 ? '+' : ''}${gain.toFixed(2)}
                          </div>
                          <div className="text-sm">
                            {gainPercent >= 0 ? '+' : ''}{gainPercent.toFixed(2)}%
                          </div>
                          <div className="text-xs text-slate-400 mt-1">
                            All-time
                          </div>
                        </div>
                      </div>
                    </div>

                    {isExpanded && (
                      <div className="mt-4 pt-4 border-t border-slate-700">
                        <h4 className="text-sm font-semibold text-slate-300 mb-3">Transactions</h4>
                        <div className="space-y-2 mb-3">
                          {holding.transactions.map((transaction) => {
                            const isEditing = editingTransaction === transaction.id;
                            const isSell = transaction.type === 'sell';
                            
                            return (
                              <div key={transaction.id} className="bg-slate-700 rounded p-3">
                                {!isEditing ? (
                                  <div className="flex justify-between items-center">
                                    <div>
                                      <div className="flex items-center gap-2">
                                        <span className={`text-xs px-2 py-0.5 rounded ${isSell ? 'bg-red-600' : 'bg-green-600'} text-white`}>
                                          {isSell ? 'SELL' : 'BUY'}
                                        </span>
                                        <span className="text-white">
                                          {transaction.quantity} × ${transaction.costBasis.toFixed(2)}
                                          {multiplier === 100 && <span className="text-slate-400"> × 100</span>}
                                        </span>
                                      </div>
                                      <div className="text-xs text-slate-400 mt-1">
                                        {new Date(transaction.date).toLocaleDateString()} · 
                                        Total: ${(transaction.quantity * transaction.costBasis * multiplier).toFixed(2)}
                                      </div>
                                    </div>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => {
                                          setEditingTransaction(transaction.id);
                                          setEditForm({
                                            quantity: transaction.quantity.toString(),
                                            costBasis: transaction.costBasis.toString(),
                                            date: transaction.date,
                                            type: transaction.type
                                          });
                                        }}
                                        className="text-blue-400 hover:text-blue-300 text-sm"
                                      >
                                        Edit
                                      </button>
                                      <button
                                        onClick={() => {
                                          const updatedHoldings = holdings.map(h => {
                                            if (h.id === holding.id) {
                                              const newTransactions = h.transactions.filter(t => t.id !== transaction.id);
                                              if (newTransactions.length === 0) {
                                                return null;
                                              }
                                              return { ...h, transactions: newTransactions };
                                            }
                                            return h;
                                          }).filter(Boolean);
                                          setHoldings(updatedHoldings);
                                        }}
                                        className="text-red-400 hover:text-red-300 text-sm"
                                      >
                                        Remove
                                      </button>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="space-y-2">
                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Type</label>
                                        <select
                                          value={editForm.type}
                                          onChange={(e) => setEditForm({...editForm, type: e.target.value})}
                                          className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                          <option value="buy">Buy</option>
                                          <option value="sell">Sell</option>
                                        </select>
                                      </div>
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Quantity</label>
                                        <input
                                          type="number"
                                          value={editForm.quantity}
                                          onChange={(e) => setEditForm({...editForm, quantity: e.target.value})}
                                          step="0.01"
                                          className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                      </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Price</label>
                                        <input
                                          type="number"
                                          value={editForm.costBasis}
                                          onChange={(e) => setEditForm({...editForm, costBasis: e.target.value})}
                                          step="0.01"
                                          className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                      </div>
                                      <div>
                                        <label className="block text-xs text-slate-400 mb-1">Date</label>
                                        <input
                                          type="date"
                                          value={editForm.date}
                                          onChange={(e) => setEditForm({...editForm, date: e.target.value})}
                                          className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                      </div>
                                    </div>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => {
                                          const updatedHoldings = holdings.map(h => {
                                            if (h.id === holding.id) {
                                              return {
                                                ...h,
                                                transactions: h.transactions.map(t => {
                                                  if (t.id === transaction.id) {
                                                    return {
                                                      ...t,
                                                      quantity: parseFloat(editForm.quantity),
                                                      costBasis: parseFloat(editForm.costBasis),
                                                      date: editForm.date,
                                                      type: editForm.type
                                                    };
                                                  }
                                                  return t;
                                                })
                                              };
                                            }
                                            return h;
                                          });
                                          setHoldings(updatedHoldings);
                                          setEditingTransaction(null);
                                        }}
                                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-sm"
                                      >
                                        Save
                                      </button>
                                      <button
                                        onClick={() => setEditingTransaction(null)}
                                        className="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-1 rounded text-sm"
                                      >
                                        Cancel
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>

                        {addingToHolding === holding.id ? (
                          <div className="bg-slate-700 rounded p-3 space-y-2">
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs text-slate-400 mb-1">Type</label>
                                <select
                                  value={quickAddForm.type}
                                  onChange={(e) => setQuickAddForm({...quickAddForm, type: e.target.value})}
                                  className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                  <option value="buy">Buy</option>
                                  <option value="sell">Sell</option>
                                </select>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-400 mb-1">Quantity</label>
                                <input
                                  type="number"
                                  value={quickAddForm.quantity}
                                  onChange={(e) => setQuickAddForm({...quickAddForm, quantity: e.target.value})}
                                  placeholder="10"
                                  step="0.01"
                                  className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs text-slate-400 mb-1">Price</label>
                                <input
                                  type="number"
                                  value={quickAddForm.costBasis}
                                  onChange={(e) => setQuickAddForm({...quickAddForm, costBasis: e.target.value})}
                                  placeholder="150.00"
                                  step="0.01"
                                  className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-400 mb-1">Date</label>
                                <input
                                  type="date"
                                  value={quickAddForm.date}
                                  onChange={(e) => setQuickAddForm({...quickAddForm, date: e.target.value})}
                                  className="w-full bg-slate-600 text-white px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => addQuickTransaction(holding.id)}
                                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 rounded text-sm"
                              >
                                Add
                              </button>
                              <button
                                onClick={() => {
                                  setAddingToHolding(null);
                                  setQuickAddForm({ quantity: '', costBasis: '', date: new Date().toISOString().split('T')[0], type: 'buy' });
                                }}
                                className="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-1 rounded text-sm"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          <button
                            onClick={() => setAddingToHolding(holding.id)}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm flex items-center justify-center gap-1"
                          >
                            <Plus className="w-4 h-4" />
                            Add Transaction
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {!showAdd && (
              <button
                onClick={() => setShowAdd(true)}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors"
              >
                <Plus className="w-5 h-5" />
                Add Transaction
              </button>
            )}

            {showAdd && (
              <div className="bg-slate-800 rounded-lg p-6 shadow-xl">
                <h3 className="text-xl font-bold text-white mb-4">Add Transaction</h3>
                <p className="text-sm text-slate-400 mb-4">
                  Enter a new purchase/sale. If the position exists, it will add to it.
                </p>
                
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm text-slate-300 mb-1">Symbol</label>
                    <input
                      type="text"
                      value={newHolding.symbol}
                      onChange={(e) => setNewHolding({...newHolding, symbol: e.target.value.toUpperCase()})}
                      placeholder="AAPL"
                      className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm text-slate-300 mb-1">Type</label>
                    <select
                      value={newHolding.type}
                      onChange={(e) => setNewHolding({...newHolding, type: e.target.value})}
                      className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="stock">Stock</option>
                      <option value="fund">Fund</option>
                      <option value="call">Call Option</option>
                      <option value="put">Put Option</option>
                    </select>
                  </div>

                  {(newHolding.type === 'call' || newHolding.type === 'put') && (
                    <>
                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Strike Price</label>
                        <input
                          type="number"
                          value={newHolding.strike}
                          onChange={(e) => setNewHolding({...newHolding, strike: e.target.value})}
                          placeholder="150.00"
                          step="0.01"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Expiration Date</label>
                        <input
                          type="date"
                          value={newHolding.expiration}
                          onChange={(e) => setNewHolding({...newHolding, expiration: e.target.value})}
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </>
                  )}

                  <div>
                    <label className="block text-sm text-slate-300 mb-1">Transaction Type</label>
                    <select
                      value={newHolding.transactionType}
                      onChange={(e) => setNewHolding({...newHolding, transactionType: e.target.value})}
                      className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="buy">Buy</option>
                      <option value="sell">Sell</option>
                    </select>
                  </div>

                  {newHolding.type === 'fund' ? (
                    <>
                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Cost Basis (Amount Invested)</label>
                        <input
                          type="number"
                          value={newHolding.costBasis}
                          onChange={(e) => setNewHolding({...newHolding, costBasis: e.target.value})}
                          placeholder="10000.00"
                          step="0.01"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Current Value (Optional)</label>
                        <input
                          type="number"
                          value={newHolding.currentValue}
                          onChange={(e) => setNewHolding({...newHolding, currentValue: e.target.value})}
                          placeholder="10000.00"
                          step="0.01"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <p className="text-xs text-slate-400 mt-1">Leave blank to auto-calculate from growth rate</p>
                      </div>

                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Annual Growth Rate (%)</label>
                        <input
                          type="number"
                          value={newHolding.growthRate}
                          onChange={(e) => setNewHolding({...newHolding, growthRate: e.target.value})}
                          placeholder="4.5"
                          step="0.1"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <p className="text-xs text-slate-400 mt-1">Typical money market fund rate</p>
                      </div>
                    </>
                  ) : (
                    <>
                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Quantity</label>
                        <input
                          type="number"
                          value={newHolding.quantity}
                          onChange={(e) => setNewHolding({...newHolding, quantity: e.target.value})}
                          placeholder="10"
                          step="0.01"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div>
                        <label className="block text-sm text-slate-300 mb-1">Price (per share/contract)</label>
                        <input
                          type="number"
                          value={newHolding.costBasis}
                          onChange={(e) => setNewHolding({...newHolding, costBasis: e.target.value})}
                          placeholder="150.00"
                          step="0.01"
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                    </>
                  )}

                  <div>
                    <label className="block text-sm text-slate-300 mb-1">Transaction Date</label>
                    <input
                      type="date"
                      value={newHolding.date}
                      onChange={(e) => setNewHolding({...newHolding, date: e.target.value})}
                      className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  <div className="flex gap-2 pt-2">
                    <button
                      onClick={addHolding}
                      className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition-colors"
                    >
                      Add
                    </button>
                    <button
                      onClick={() => {
                        setShowAdd(false);
                        setNewHolding({ symbol: '', quantity: '', costBasis: '', type: 'stock', strike: '', expiration: '', date: new Date().toISOString().split('T')[0], transactionType: 'buy', currentValue: '' });
                      }}
                      className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-semibold transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            {holdings.length === 0 && !showAdd && (
              <div className="text-center text-slate-400 py-12">
                <p>No positions yet. Add your first one to get started!</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<PortfolioTracker />, document.getElementById('root'));
  </script>
</body>
</html>